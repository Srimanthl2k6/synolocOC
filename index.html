<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synolo Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for a more integrated look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e2e; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <!-- ======================================================================
    == 1. CONFIGURATION: PASTE YOUR DEPLOYED APPS SCRIPT URL HERE
    ======================================================================= -->
    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxXNXdAo_YgP6kIzvvI4K-GIMF2lNYSAETeAeyNfF3qUklIR_ssokeYYthLF89T750z/exec";
    </script>
    <!-- ====================================================================== -->

    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-purple-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-lg font-medium">Loading Applications...</p>
        </div>
    </div>
    
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white">
                ðŸŽµ <span class="bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 text-transparent bg-clip-text">Synolo Applications</span>
            </h1>
            <p class="text-gray-400 mt-2">Real-time dashboard for applicant management.</p>
        </header>

        <!-- Statistics Cards -->
        <div id="stats-container" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8 md:mb-12">
            <!-- Stats will be injected here by JS -->
        </div>
        
        <!-- Applications Container -->
        <main id="applications-container" class="space-y-6">
            <!-- Application cards will be injected here by JS -->
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const statsContainer = document.getElementById('stats-container');
            const applicationsContainer = document.getElementById('applications-container');

            if (!SCRIPT_URL || SCRIPT_URL === "YOUR_DEPLOYED_APPS_SCRIPT_URL_HERE") {
                loadingOverlay.innerHTML = `<div class="text-center text-red-400 p-8 rounded-lg bg-gray-800 shadow-xl">
                    <h2 class="text-2xl font-bold mb-2">Configuration Error</h2>
                    <p>Please paste your Google Apps Script URL into the &lt;script&gt; tag in the HTML file.</p>
                </div>`;
                return;
            }

            // --- DATA FETCHING ---
            async function fetchApplications() {
                try {
                    const response = await fetch(SCRIPT_URL);
                    const result = await response.json();
                    
                    if (result.success) {
                        renderDashboard(result.data);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error("Error fetching applications:", error);
                    applicationsContainer.innerHTML = `<div class="text-center text-red-400 p-8 rounded-lg bg-gray-800 shadow-xl">
                        <h2 class="text-2xl font-bold mb-2">Failed to Load Data</h2>
                        <p>${error.message}</p>
                        <p class="mt-4 text-sm text-gray-400">Please check the script URL, spreadsheet ID, and deployment permissions.</p>
                    </div>`;
                } finally {
                    loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => loadingOverlay.style.display = 'none', 300);
                }
            }

            // --- UI RENDERING ---
            function renderDashboard(data) {
                renderStatistics(data);
                renderApplications(data);
            }

            function renderStatistics(data) {
                const stats = { total: data.length, new: 0, shortlisted: 0, rejected: 0 };
                data.forEach(app => {
                    const status = app[8] || 'New';
                    if (status === 'New') stats.new++;
                    else if (status === 'Shortlisted') stats.shortlisted++;
                    else if (status === 'Rejected') stats.rejected++;
                });

                const statCards = [
                    { label: 'Total', value: stats.total, color: 'from-blue-500 to-indigo-500' },
                    { label: 'New', value: stats.new, color: 'from-gray-500 to-gray-600' },
                    { label: 'Shortlisted', value: stats.shortlisted, color: 'from-green-500 to-teal-500' },
                    { label: 'Rejected', value: stats.rejected, color: 'from-red-500 to-pink-500' }
                ];

                statsContainer.innerHTML = statCards.map(card => `
                    <div class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700 text-center">
                        <div class="text-3xl font-bold bg-gradient-to-r ${card.color} text-transparent bg-clip-text">${card.value}</div>
                        <div class="text-sm uppercase text-gray-400 font-medium">${card.label}</div>
                    </div>
                `).join('');
            }

            function renderApplications(data) {
                if(data.length === 0) {
                     applicationsContainer.innerHTML = `<div class="text-center text-gray-500 py-16">No applications received yet.</div>`;
                     return;
                }
                applicationsContainer.innerHTML = data.map((app, index) => {
                    const rowNumber = index + 2; // +2 because sheet is 1-indexed and we skip the header
                    const status = app[8] || 'New';
                    const [statusColor, statusRingColor] = getStatusColors(status);
                    
                    return `
                    <div class="application-card bg-gray-800 rounded-xl shadow-lg border border-gray-700 overflow-hidden transition-all duration-300" data-row="${rowNumber}">
                        <div class="p-5 border-b border-gray-700 flex justify-between items-start gap-4">
                            <div>
                                <h3 class="font-bold text-lg text-white">${app[1] || 'Unknown Applicant'}</h3>
                                <p class="text-sm text-gray-400">Applied on: ${new Date(app[0]).toLocaleDateString()}</p>
                            </div>
                            <span class="status-badge text-xs font-bold uppercase px-3 py-1 rounded-full ${statusColor}">${status}</span>
                        </div>

                        <div class="p-5 grid md:grid-cols-3 gap-6">
                            <div class="md:col-span-1 space-y-3 text-sm">
                                ${infoItem('Roll Number', app[2])}
                                ${infoItem('Contact', app[3])}
                                ${infoItem('Team Preference', app[4], true)}
                            </div>
                            <div class="md:col-span-2 space-y-4">
                                ${detailSection('What makes them different:', app[5])}
                                ${app[6] ? detailSection('Event Idea:', app[6]) : ''}
                                ${app[7] ? `<a href="${app[7]}" target="_blank" class="text-indigo-400 hover:text-indigo-300 font-semibold text-sm">View Portfolio &rarr;</a>` : ''}
                            </div>
                        </div>

                        <div class="p-4 bg-gray-800/50 border-t border-gray-700 flex justify-center items-center gap-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="status-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-green-500 focus:ring-green-500" data-type="Shortlisted" ${status === 'Shortlisted' ? 'checked' : ''}>
                                <span class="font-medium text-green-400">Shortlist</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" class="status-checkbox h-5 w-5 rounded bg-gray-700 border-gray-600 text-red-500 focus:ring-red-500" data-type="Rejected" ${status === 'Rejected' ? 'checked' : ''}>
                                <span class="font-medium text-red-400">Reject</span>
                            </label>
                        </div>
                    </div>
                    `;
                }).join('');

                addCheckboxListeners();
            }

            // --- HELPERS & EVENT LISTENERS ---
            function infoItem(label, value, isBadge = false) {
                if (!value) return '';
                const valueHTML = isBadge ? `<span class="bg-purple-500/50 text-purple-300 px-2 py-0.5 rounded-md text-xs font-semibold">${value}</span>` : `<span class="text-gray-300">${value}</span>`;
                return `<div class="flex flex-col"><span class="font-semibold text-gray-400">${label}</span> ${valueHTML}</div>`;
            }

            function detailSection(title, text) {
                return `<div>
                            <h4 class="font-semibold text-gray-300 mb-1">${title}</h4>
                            <p class="text-sm text-gray-400 bg-gray-900/50 p-3 rounded-md border border-gray-700">${text}</p>
                        </div>`;
            }

            function getStatusColors(status) {
                switch(status) {
                    case 'Shortlisted': return ['bg-green-500/20 text-green-300', 'ring-green-500'];
                    case 'Rejected': return ['bg-red-500/20 text-red-300', 'ring-red-500'];
                    default: return ['bg-gray-500/20 text-gray-300', 'ring-gray-500'];
                }
            }

            function addCheckboxListeners() {
                document.querySelectorAll('.status-checkbox').forEach(box => {
                    box.addEventListener('change', handleStatusUpdate);
                });
            }

            async function handleStatusUpdate(event) {
                const checkbox = event.target;
                const card = checkbox.closest('.application-card');
                const row = card.dataset.row;
                const type = checkbox.dataset.type;
                const checkboxesInCard = card.querySelectorAll('.status-checkbox');
                
                // Uncheck other box if this one is checked
                if (checkbox.checked) {
                    checkboxesInCard.forEach(box => {
                        if (box !== checkbox) box.checked = false;
                    });
                }
                
                const newStatus = checkbox.checked ? type : 'New';

                // Optimistically update UI
                card.classList.add('opacity-50', 'pointer-events-none');
                updateCardUI(card, newStatus);
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Required for Apps Script
                        body: JSON.stringify({ action: 'update_status', row: row, status: newStatus })
                    });
                    const result = await response.json();

                    if (!result.success) throw new Error(result.error);
                    
                    // Success! Show a temporary success ring
                    const [_, ringColor] = getStatusColors(newStatus);
                    card.classList.add('ring-2', ringColor);
                    setTimeout(() => card.classList.remove('ring-2', ringColor), 2000);

                } catch (error) {
                    console.error('Failed to update status:', error);
                    // TODO: Revert UI on failure
                    alert(`Error: Could not update applicant status. Please try again.\n\n${error.message}`);
                } finally {
                     card.classList.remove('opacity-50', 'pointer-events-none');
                }
            }

            function updateCardUI(card, status) {
                const badge = card.querySelector('.status-badge');
                const [statusColor, _] = getStatusColors(status);
                badge.className = `status-badge text-xs font-bold uppercase px-3 py-1 rounded-full ${statusColor}`;
                badge.textContent = status;
            }

            // Initial fetch
            fetchApplications();
        });
    </script>
</body>
</html>
